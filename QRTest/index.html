<!DOCTYPE html>
<html>
<head>
  <title>QRコードスキャナー</title>
  <script src="https://rawgit.com/sitepoint-editors/jsqrcode/master/src/qr_packed.js"></script>
</head>
<body>
  <video id="video" width="300" height="300" style="border: 1px solid gray"></video>
  <canvas id="canvas" width="300" height="300" style="display: none;"></canvas>
  <script>
    // カメラを起動するための関数
    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) {
          var video = document.getElementById('video');
          video.srcObject = stream;
          video.play();
        })
        .catch(function(error) {
          console.error("カメラの起動に失敗しました: ", error);
        });
    }

    // QRコードをスキャンするための関数
    function scanQRCode() {
      var video = document.getElementById('video');
      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, 300, 300);
      try {
        qrcode.decode();
      } catch (error) {
        console.error("QRコードの読み取りに失敗しました: ", error);
        setTimeout(scanQRCode, 300);
      }
    }

    // QRコードが読み込まれたときの処理
    function qrCodeScanned(data) {
      console.log("QRコードが読み取られました: ", data);
      // ここで取得したデータを利用する処理を記述します

      // 再度QRコードをスキャンするために呼び出します
      setTimeout(scanQRCode, 300);
    }

    // QRコードの読み取りを初期化するための関数
    function initQRCodeReader() {
      var video = document.getElementById('video');
      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');
      qrcode.callback = qrCodeScanned;

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // カメラを起動してQRコードを読み取る
        startCamera();

        video.addEventListener('play', function() {
          // カメラの映像が再生されたらQRコードを読み取る
          setTimeout(scanQRCode, 300);
        });
      } else {
        console.error("getUserMediaがサポートされていません");
      }
    }

    // ページが読み込まれたときにQRコードの読み取りを初期化します
    window.onload = function() {
      initQRCodeReader();
    };
  </script>
</body>
</html>
